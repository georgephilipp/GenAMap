##############################################
##          CREATE TABLES                   ##
##############################################

# Master Copy of all database data tables

CREATE TABLE traitset(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(20) NOT NULL, projectid INT NOT NULL, speciesid INT NOT NULL, goannos CHAR(200) DEFAULT '.', loadcmpt INT NOT NULL DEFAULT 0, hasdata BOOL NOT NULL DEFAULT 1, FOREIGN KEY(speciesid) REFERENCES species(id), FOREIGN KEY (projectid) REFERENCES project(id)) ENGINE=INNODB;
CREATE TABLE markerset(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(20) NOT NULL, projectid INT NOT NULL, loadcmpt INT NOT NULL DEFAULT 0, hasdata BOOL NOT NULL DEFAULT 1, FOREIGN KEY (projectid) REFERENCES project(id)) ENGINE=INNODB;

CREATE TABLE assocset(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(20) NOT NULL, projectid INT NOT NULL, thresh FLOAT, netid INT(11), tsid INT(11) NOT NULL, msid INT(11) NOT NULL, ispval BOOL NOT NULL DEFAULT FALSE, popid INT DEFAULT -1, popnum INT DEFAULT 1, FOREIGN KEY (tsid) REFERENCES traitset(id), FOREIGN KEY (msid) REFERENCES markerset(id), FOREIGN KEY (projectid) REFERENCES project(id)) ENGINE=INNODB;
 
CREATE TABLE sample(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(30) UNIQUE) ENGINE=INNODB;
 
CREATE TABLE trait(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(30), idx INT NOT NULL, traitsetid INT NOT NULL, golistid INT DEFAULT -1, FOREIGN KEY (traitsetid) REFERENCES traitset(id)) ENGINE=INNODB;

CREATE TABLE traitval(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, sampleid INT NOT NULL, traitid INT NOT NULL, value FLOAT NOT NULL, FOREIGN KEY (traitid) REFERENCES trait(id), FOREIGN KEY (sampleid) REFERENCES sample(id)) ENGINE=INNODB;

CREATE TABLE network(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, type CHAR(3), ts INT NOT NULL, name CHAR(30), FOREIGN KEY (ts) REFERENCES traitset(id)) ENGINE=INNODB; 

CREATE TABLE networkval(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, trait1 INT NOT NULL, trait2 INT NOT NULL, netid INT NOT NULL, weight FLOAT NOT NULL, FOREIGN KEY (trait1) REFERENCES trait(id), FOREIGN KEY (trait2) REFERENCES trait(id), FOREIGN KEY (netid) REFERENCES network(id)) ENGINE=INNODB;
 
CREATE TABLE marker(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(50), chr INT NOT NULL, locus INT NOT NULL, idx INT NOT NULL, markersetid INT NOT NULL, FOREIGN KEY (markersetid) REFERENCES markerset(id)) ENGINE=INNODB;
 
CREATE TABLE markerval(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, sampleid INT NOT NULL, markerid INT NOT NULL, value INT NOT NULL, FOREIGN KEY (markerid) REFERENCES marker(id), FOREIGN KEY (sampleid) REFERENCES sample(id)) ENGINE=INNODB;

CREATE TABLE association(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, markerid INT NOT NULL, traitid INT NOT NULL, value FLOAT NOT NULL, assocsetid INT NOT NULL, popref INT DEFAULT -1, FOREIGN KEY (assocsetid) REFERENCES assocset(id), FOREIGN KEY (markerid) REFERENCES marker(id), FOREIGN KEY (traitid) REFERENCES trait(id)) ENGINE=INNODB;

CREATE TABLE genetraitassocset(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name CHAR(50) NOT NULL, geneid INT NOT NULL, traitid INT NOT NULL, genenetid INT NOT NULL, traitnetid INT NOT NULL, snpassocid INT NOT NULL, FOREIGN KEY (geneid) REFERENCES traitset(id), FOREIGN KEY (traitid) REFERENCES traitset(id), FOREIGN KEY (genenetid) REFERENCES network(id), FOREIGN KEY (traitnetid) REFERENCES network(id), FOREIGN KEY (snpassocid) REFERENCES assocset(id), UNIQUE(geneid, traitid, snpassocid)) ENGINE=INNODB;

CREATE TABLE genegroups(geneid INT NOT NULL, grp INT NOT NULL, gtassocsetid INT NOT NULL, UNIQUE (geneid, gtassocsetid), FOREIGN KEY (gtassocsetid) REFERENCES genetraitassocset(id), FOREIGN KEY (geneid) REFERENCES trait(id)) ENGINE = INNODB;

ALTER TABLE genegroups ADD COLUMN golistid INT NOT NULL DEFAULT -1;

CREATE TABLE genetraitassociation(geneid INT NOT NULL, traitid INT NOT NULL, gtassocsetid INT NOT NULL, value FLOAT NOT NULL, UNIQUE(geneid, traitid, gtassocsetid), FOREIGN KEY (geneid) REFERENCES trait(id), FOREIGN KEY (traitid) REFERENCES trait(id), FOREIGN KEY (gtassocsetid) REFERENCES genetraitassocset(id)) ENGINE = INNODB;

CREATE TABLE cluster(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, traitid INT NOT NULL, netid INT NOT NULL, name CHAR(30) NOT NULL, value LONGTEXT NOT NULL, FOREIGN KEY (traitid) REFERENCES traitset(id) ON DELETE CASCADE, FOREIGN KEY (netid) REFERENCES network(id) ON DELETE CASCADE) ENGINE = INNODB;

CREATE TABLE eQTLlist (id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, list LONGTEXT) ENGINE = INNODB;

CREATE TABLE netmodule (id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, netid INT NOT NULL, idx INT NOT NULL, traitlistid INT NOT NULL, assocsetid INT NOT NULL, golistid INT NOT NULL, eQTLlistid INT NOT NULL, goanno CHAR(50) NOT NULL, clusterid INT NOT NULL, FOREIGN KEY (clusterid) REFERENCES cluster(id), FOREIGN KEY (netid) REFERENCES network(id), FOREIGN KEY (traitlistid) REFERENCES traitlist(id), FOREIGN KEY (assocsetid) REFERENCES assocset(id), FOREIGN KEY (eQTLlistid) REFERENCES eQTLlist(id)) ENGINE = INNODB;

CREATE TABLE traittree(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, tsid INT NOT NULL, name CHAR(50) NOT NULL, loadcmpt TINYINT(1) DEFAULT 0, updated TINYINT(1) DEFAULT 0, FOREIGN KEY (tsid) REFERENCES traitset(id)) ENGINE = INNODB;
ALTER TABLE traittree ADD UNIQUE(tsid, name);
ALTER TABLE traittree ADD COLUMN gomethod CHAR(50) DEFAULT 'HG,FDR,.05';
ALTER TABLE traittreeval ALTER traitlist SET DEFAULT 1;

CREATE TABLE traittreeval(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, traitid INT DEFAULT -1, parentid INT NOT NULL, level INT NOT NULL, ttid INT NOT NULL, traitlist INT NOT NULL, FOREIGN KEY (ttid) REFERENCES traittree(id), FOREIGN KEY parent REFERENCES (id)) ENGINE = INNODB;

CREATE TABLE golist (id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, list LONGTEXT) ENGINE = INNODB;
CREATE TABLE traitlist (id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, list LONGTEXT) ENGINE = INNODB;

CREATE TABLE traitsubset (id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, name VARCHAR(255) NOT NULL, tsid INT NOT NULL, traitlist INT NOT NULL, golist INT DEFAULT -1, FOREIGN KEY (traitlist) references traitlist(id), FOREIGN KEY (tsid) REFERENCES traitset(id));

CREATE TABLE popstruct(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, markersetid INT NOT NULL, name CHAR(30) NOT NULL, loadcmpt TINYINT (1) DEFAULT 0, FOREIGN KEY (markersetid) REFERENCES markerset(id)) ENGINE = INNODB;

CREATE TABLE structure(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, popstructid INT NOT NULL, sampleid INT NOT NULL, pop1 INT, pop2 INT, pop3 INT, pop4 INT, pop5 INT , pop6 INT, pop7 INT, pop8 INT, pop9 INT, pop10 INT, eig1 FLOAT, eig2 FLOAT, eig3 FLOAT, eig4 FLOAT, eig5 FLOAT, FOREIGN KEY (popstructid) REFERENCES popstruct(id), FOREIGN KEY (sampleid) REFERENCES sample(id)) ENGINE = INNODB;

#CREATE TABLE list(id INT NOT NULL AUTO_INCREMENT PRIMARY KEY) ENGINE = INNODB;

#CREATE TABLE listval(listid INT NOT NULL, refid INT NOT NULL, FOREIGN KEY (listid) REFERENCES list(id)) ENGINE = INNODB;

ALTER TABLE marker ADD UNIQUE(chr, locus, markersetid);
ALTER TABLE marker ADD UNIQUE(idx, markersetid);
ALTER TABLE assocset ADD UNIQUE(name, projectid);
ALTER TABLE project ADD UNIQUE(name);
ALTER TABLE markerset ADD UNIQUE(name, projectid);
ALTER TABLE markerval ADD UNIQUE(sampleid, markerid);
ALTER TABLE traitset ADD UNIQUE(name, projectid);
ALTER TABLE sample ADD UNIQUE (name, idx, projectid);
ALTER TABLE trait ADD UNIQUE (name, traitsetid);
ALTER TABLE trait ADD UNIQUE (idx, traitsetid);
ALTER TABLE traitval ADD UNIQUE (sampleid, traitid);
ALTER TABLE networkval ADD UNIQUE (netid, trait1, trait2);
ALTER TABLE network ADD UNIQUE(ts, type);
ALTER TABLE cluster ADD UNIQUE(traitid, netid, name);

ALTER TABLE traitset ADD COLUMN loadcmpt BOOLEAN DEFAULT false;
ALTER TABLE markerset ADD COLUMN loadcmpt BOOLEAN DEFAULT false;
ALTER TABLE assocset ADD COLUMN loadcmpt BOOLEAN DEFAULT false;
ALTER TABLE network ADD COLUMN loadcmpt BOOLEAN DEFAULT false;
ALTER TABLE traittree ADD COLUMN  loadcmpt BOOLEAN DEFAULT false;

